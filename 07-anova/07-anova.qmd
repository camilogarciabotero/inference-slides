---
title: ANOVA
subtitle: "https://bit.ly/41mzUK9"
author:
  - name: Camilo G.
    email: ca.garcia2@uniandes.edu.co

  - name: "Kevin J."
    email: d.vivasb@uniandes.edu.co

  - name: "Victor A."
    email: v.nascimento@uniandes.edu.co
format:
  revealjs:
    footer: |
      BIOL2205 - IeI - Universidad de los Andes
    standalone: true
    preview-links: auto
    center: true
    slide-number: true
    fig-align: center
    code-line-numbers: false
    overview: true
    code-link: true
    code-annotations: hover
    highlight-style: ayu
    df-print: paged
    scrollable: true
    fig-height: 5
    fig-width: 5
    fig-dpi: 350
    theme: ../theme.scss
    bibliography: ../references.bib
---

```{r}
#| label: theme-set
#| eval: true
library(tidyverse)
library(palmerpenguins)
library(latex2exp)
library(performance)
library(statsExpressions)
library(ggsignif)

simple_theme <- theme_bw() +
    theme(
        plot.background = element_rect(fill = "#FDF6E3"),
        panel.background = element_rect(fill = "#FDF6E3"),
        legend.background = element_rect(fill = "#FDF6E3"),
        legend.position = "bottom",
        axis.title = element_text(size = 14)
    )

theme_set(simple_theme)
```

## When do we apply ANOVA

. . .

When comparing a continuous variable across two or more groups. The question it tries to solve is: "is there a group different from the others?"

## Establishing the hypothesis

***

![](figs/null-hypothesis.png){fig-align="center" width="600"}

***

![](figs/alternative-hypothesis.png){fig-align="center" width="600"}


***


##

![](figs/anova.png){fig-align="center" width="600"}

##

![](figs/within-groups.png){fig-align="center" width="600"}

##

![](figs/among-groups.png){fig-align="center" width="600"}

##

![](figs/total.png)

## Understanding the fisher distribution


![](figs/fisher-test.png){fig-align="center" width="350"}

*** 

![](figs/fisher.png){fig-align="center" width="350"}

***

## ANOVA assumptions

1. Samples are independent (randomly sampled)
2. Variance is homogenous/constant
3. Residuals are normally distributed


## Let's try with an example

***

```{r}
#| label: simple-barplots-01
#| fig-align: center
#| echo: false
#| eval: true
#| output-location: fragment

ggplot(penguins, aes(x = species, y = body_mass_g, fill = species)) +
  geom_boxplot(alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.7) +
  labs(y = "Body mass (g)")
```

***

##  {auto-animate="true"}

```{r}
#| label: simple-frequencies-01
#| fig-align: center
#| echo: false
#| eval: true
#| output-location: fragment

males  <- penguins |> 
  filter(sex == "male")

ggplot(males) +
  geom_density(aes(x = body_mass_g, fill = species), alpha = .6)
```

##  {auto-animate="true"}


```{r}
#| label: simple-frequencies-02
#| fig-align: center
#| echo: false
#| eval: true
#| output-location: fragment

ggplot(males) +
  geom_density(aes(x = body_mass_g, fill = species), alpha = .6) +
  geom_density(aes(x = body_mass_g), fill = "gray", alpha = 0.7)
```


## Applying ANOVA with different approaches

***

### 1. Using `aov()` function:

```{r}
#| label: anova-01
#| fig-align: center
#| echo: true
#| eval: true
#| output-location: fragment
anovamodel <- aov(data = males, body_mass_g ~ species)
anovamodel
```

***

The Tukey-Krammer test to make pairwise comparisons:
```{r}
TukeyHSD(anovamodel)
```

***

### 2. Using the `statsExpression` package:

```{r}
#| label: anova-02
#| fig-align: center
#| echo: true
#| eval: true
#| output-location: fragment
anovatbl <- oneway_anova(data = penguins, x = species, y = body_mass_g)
anovatbl
```


## Adding stats to the plots!

***

```{r}
#| label: barplot-expressions
#| fig-align: center
#| echo: true
#| eval: true
#| output-location: column-fragment

ggplot(males, 
  aes(
    x = species, 
    y = body_mass_g, 
    fill = species
    )) +
  geom_boxplot(alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.7) +
  labs(
    y = "Body mass (g)",
    subtitle = anovatbl$expression[[1]]
    )
```

## But why there are not comparisons?


## Adding pairwise comparisons

```{r}
#| label: barplot-signif
#| fig-align: center
#| echo: true
#| eval: true
#| output-location: column-fragment

ggplot(males, 
  aes(
    x = species, 
    y = body_mass_g, 
    fill = species
    )) +
  geom_boxplot(alpha = 0.5) +
  geom_jitter(width = 0.2, alpha = 0.7) +
  labs(
    y = "Body mass (g)",
    subtitle = anovatbl$expression[[1]]
    ) +
  geom_signif(
    comparisons = list(
      c("Gentoo", "Chinstrap"),
      c("Adelie", "Chinstrap"),
      c("Adelie", "Gentoo")
    ),
    step_increase = 0.2,
    map_signif_level = TRUE
  )
```

## Testing the ANOVA assumptions with `performance`

***

1. Sample and residuals independence: 

```{r}
#| label: independence0
#| fig-align: center
#| echo: true
#| eval: true
check_autocorrelation(anovamodel)
```

***

2. Normality of the residuals:

```{r}
#| label: normality0
#| fig-align: center
#| echo: true
#| eval: true
check_normality(anovamodel)
```

. . . 

```{r}
#| label: normality
#| fig-align: center
#| echo: true
#| eval: true
#| layout-ncol: 2
plot(check_normality(anovamodel))
plot(check_normality(anovamodel), type = "qq")
```

***

3. Homogeneity of the variance: 

```{r}
#| label: heteroskedasticity0
#| fig-align: center
#| echo: true
#| eval: true
check_heteroskedasticity(anovamodel)
```

. . .

```{r}
#| label: heteroskedasticity
#| fig-align: center
#| echo: true
#| eval: true
#| layout-ncol: 2
plot(check_heteroskedasticity(anovamodel))
plot(check_homogeneity(anovamodel))
```

***

Checking influential observations (outliers)

```{r}
#| label: outliers0
#| fig-align: center
#| echo: true
#| eval: true
check_outliers(anovamodel)
```

## What if normality and homogeneity of variance are not met then?

***

The Kruskal-Wallis test is a non-parametric alternative to the ANOVA test.

```{r}
#| label: Kruskal-Wallis
#| fig-align: center
#| echo: true
#| eval: true
kruskal.test(data = males, body_mass_g ~ species)
```
